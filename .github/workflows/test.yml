name: Build-FanchmWrt-X86-64
on:
  repository_dispatch:
  workflow_dispatch:

# æƒé™é…ç½®é›†ä¸­ç®¡ç†
permissions:
  contents: write
  actions: write

# ç¯å¢ƒå˜é‡ç»Ÿä¸€é…ç½®ï¼Œå¢åŠ è¯­ä¹‰åŒ–æ³¨é‡Š
env:
  # æºç ä»“åº“é…ç½®
  REPO_URL: https://github.com/fanchmwrt/fanchmwrt/
  REPO_BRANCH: fanchmwrt-24.10.4
  
  # è‡ªå®šä¹‰æ–‡ä»¶è·¯å¾„
  FEEDS_CONF: FanchmWrt/feeds.conf.default
  CONFIG_FILE: FanchmWrt/fanchmwrtamd64.config
  DIY_P1_SH: FanchmWrt/diy-part1.sh
  DIY_P2_SH: FanchmWrt/diy-part2.sh
  PLUGINS_FILE: FanchmWrt/plugins.txt
  
  # ä¸Šä¼ é…ç½®å¼€å…³
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  
  # ç³»ç»Ÿé…ç½®
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    # è®¾ç½®shellé€‰é¡¹ï¼Œå¢å¼ºè„šæœ¬å¥å£®æ€§
    defaults:
      run:
        shell: bash -euo pipefail {0}
    
    steps:
      - name: 1. æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v4

      - name: 2. åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ (Initialization Environment)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "ğŸ“¦ æ¸…ç†ç³»ç»Ÿå†—ä½™æ–‡ä»¶ï¼Œé‡Šæ”¾ç£ç›˜ç©ºé—´"
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          
          echo "ğŸ“¦ æ›´æ–°è½¯ä»¶æºå¹¶å®‰è£…ç¼–è¯‘ä¾èµ–"
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache \
            cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
            git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
            libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
            libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch \
            pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils rsync scons \
            squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          
          echo "ğŸ“¦ æ¸…ç†aptç¼“å­˜ï¼Œè®¾ç½®æ—¶åŒº"
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          
          echo "ğŸ“¦ åˆ›å»ºå·¥ä½œç›®å½•å¹¶è®¾ç½®æƒé™"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: 3. å…‹éš†æºä»£ç  (Clone Source Code)
        working-directory: /workdir
        run: |
          echo "ğŸ“¥ æŸ¥çœ‹ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ"
          df -hT $PWD
          
          echo "ğŸ“¥ å…‹éš†FanchmWrtæºç ä»“åº“"
          git clone --depth=1 $REPO_URL -b $REPO_BRANCH fanchmwrt
          ln -sf /workdir/fanchmwrt $GITHUB_WORKSPACE/fanchmwrt
          echo "âœ… æºç å…‹éš†å®Œæˆï¼Œå·¥ä½œç›®å½•ï¼š/workdir/fanchmwrt"

      - name: 4. åŠ è½½è‡ªå®šä¹‰è®¢é˜…æº (Load Custom Feeds)
        run: |
          echo "ğŸ”§ åŠ è½½è‡ªå®šä¹‰feedsé…ç½®æ–‡ä»¶"
          [ -e "$FEEDS_CONF" ] && mv "$FEEDS_CONF" fanchmwrt/feeds.conf.default && echo "âœ… å·²æ›¿æ¢feeds.conf.default"
          
          echo "ğŸ”§ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬diy-part1.sh"
          chmod +x "$DIY_P1_SH"
          cd fanchmwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH
          echo "âœ… diy-part1.sh æ‰§è¡Œå®Œæˆ"

      - name: 5. æ›´æ–°å¹¶å®‰è£…è½¯ä»¶æº (Update & Install Feeds)
        run: |
          echo "ğŸ”„ æ›´æ–°è½¯ä»¶æº"
          cd fanchmwrt && ./scripts/feeds update -a
          
          echo "ğŸ”„ å®‰è£…è½¯ä»¶æº"
          cd fanchmwrt && ./scripts/feeds install -a
          echo "âœ… è½¯ä»¶æºæ›´æ–°å®‰è£…å®Œæˆ"

      - name: 6. åŠ è½½è‡ªå®šä¹‰é…ç½® (Load Custom Configuration)
        run: |
          echo "ğŸ”§ å¤åˆ¶è‡ªå®šä¹‰filesç›®å½•"
          [ -e "FanchmWrt/files" ] && mv FanchmWrt/files fanchmwrt/files && echo "âœ… å·²å¤åˆ¶è‡ªå®šä¹‰filesç›®å½•"
          
          echo "ğŸ”§ å¤åˆ¶è‡ªå®šä¹‰é…ç½®æ–‡ä»¶"
          [ -e "$CONFIG_FILE" ] && mv "$CONFIG_FILE" fanchmwrt/.config && echo "âœ… å·²æ›¿æ¢.configé…ç½®æ–‡ä»¶"
          
          echo "ğŸ”§ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬diy-part2.sh"
          chmod +x "$DIY_P2_SH"
          cd fanchmwrt
          $GITHUB_WORKSPACE/$DIY_P2_SH
          echo "âœ… diy-part2.sh æ‰§è¡Œå®Œæˆ"

      - name: 7. æå–å›ºä»¶é»˜è®¤ç®¡ç†IP (Extract Management IP)
        id: extract_ip
        run: |
          cd fanchmwrt
          MANAGE_IP=""
          CONFIG_GENERATE="package/base-files/files/bin/config_generate"
          
          echo "ğŸ” ä»config_generateæå–ç®¡ç†IP"
          if [ -f "$CONFIG_GENERATE" ]; then
            MANAGE_IP=$(grep -oP '192\.168\.\d+\.\d+' "$CONFIG_GENERATE" | head -1)
            echo "â„¹ï¸ ä»config_generateæå–åˆ°IP: $MANAGE_IP"
          fi
          
          echo "ğŸ” ä»networké…ç½®æ–‡ä»¶æå–ç®¡ç†IPï¼ˆå¤‡ç”¨ï¼‰"
          if [ -z "$MANAGE_IP" ] && [ -f "files/etc/config/network" ]; then
            MANAGE_IP=$(grep -A 10 'config interface 'lan'' "files/etc/config/network" | grep 'option ipaddr' | sed -r 's/.*ipaddr[[:space:]]*"(.*)"/\1/' | head -1)
            echo "â„¹ï¸ ä»networké…ç½®æå–åˆ°IP: $MANAGE_IP"
          fi
          
          # å…œåº•é»˜è®¤å€¼
          MANAGE_IP=${MANAGE_IP:-"192.168.1.1"}
          echo "MANAGE_IP=$MANAGE_IP" >> "$GITHUB_ENV"
          echo "âœ… æœ€ç»ˆç®¡ç†IPï¼š$MANAGE_IP"

      - name: 8. ç”Ÿæˆç¼–è¯‘ç›¸å…³å˜é‡ (Generate Compilation Variables)
        id: gen_vars
        run: |
          echo "ğŸ“… ç”Ÿæˆç¼–è¯‘æ—¶é—´å’ŒReleaseæ ‡ç­¾"
          COMPILE_TIME=$(date +"%Y-%m-%d %H:%M:%S")
          RELEASE_TAG=$(date +"%Y.%m.%d-%H%M")
          
          echo "COMPILE_TIME=$COMPILE_TIME" >> "$GITHUB_ENV"
          echo "RELEASE_TAG=$RELEASE_TAG" >> "$GITHUB_ENV"
          echo "âœ… ç¼–è¯‘æ—¶é—´ï¼š$COMPILE_TIME"
          echo "âœ… Releaseæ ‡ç­¾ï¼š$RELEASE_TAG"

      - name: 9. ä¸‹è½½è½¯ä»¶åŒ… (Download Packages)
        id: package
        run: |
          cd fanchmwrt
          echo "ğŸ”§ ç”Ÿæˆé»˜è®¤é…ç½®æ–‡ä»¶"
          make defconfig
          
          echo "ğŸ“¥ å¹¶è¡Œä¸‹è½½è½¯ä»¶åŒ…ï¼ˆ8çº¿ç¨‹ï¼‰"
          make download -j8
          
          echo "ğŸ§¹ æ¸…ç†æ— æ•ˆä¸‹è½½æ–‡ä»¶ï¼ˆå°äº1KBï¼‰"
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          echo "âœ… è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"

      - name: 10. è®°å½•ç¼–è¯‘å¼€å§‹æ—¶é—´ (Record Compile Start Time)
        id: start_compile
        run: |
          COMPILE_START=$(date +%s)
          echo "COMPILE_START=$COMPILE_START" >> "$GITHUB_ENV"
          echo "âœ… ç¼–è¯‘å¼€å§‹æ—¶é—´æˆ³ï¼š$COMPILE_START"

      - name: 11. ç¼–è¯‘å›ºä»¶ (Compile Firmware)
        id: compile
        run: |
          cd fanchmwrt
          THREAD_COUNT=$(nproc)
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶ï¼Œä½¿ç”¨ $THREAD_COUNT çº¿ç¨‹"
          
          # å°è¯•å¤šçº¿ç¨‹ç¼–è¯‘ï¼Œå¤±è´¥åˆ™é™çº§å•çº¿ç¨‹
          make -j"$THREAD_COUNT" || make -j1 || make -j1 V=s
          echo "status=success" >> "$GITHUB_OUTPUT"
          
          # æå–è®¾å¤‡ä¿¡æ¯
          echo "ğŸ” æå–è®¾å¤‡ä¿¡æ¯"
          DEVICE=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/')
          ARCH=$(grep '^CONFIG_TARGET_ARCH_PACKAGES=' .config | sed -r 's/.*="(.*)"/\1/')
          FULL_DEVICE_NAME="${DEVICE} ${ARCH}"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          [ -n "$DEVICE" ] && echo "DEVICE_NAME=_$DEVICE" >> "$GITHUB_ENV"
          echo "FULL_DEVICE_NAME=$FULL_DEVICE_NAME" >> "$GITHUB_ENV"
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> "$GITHUB_ENV"
          
          echo "âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ"
          echo "â„¹ï¸ è®¾å¤‡ä¿¡æ¯ï¼š$FULL_DEVICE_NAME"

      - name: 12. è®¡ç®—ç¼–è¯‘æ—¶é•¿ (Calculate Compile Duration)
        id: calc_duration
        if: steps.compile.outputs.status == 'success' && !cancelled()
        run: |
          echo "â±ï¸ è®¡ç®—ç¼–è¯‘è€—æ—¶"
          COMPILE_END=$(date +%s)
          DURATION_SEC=$((COMPILE_END - COMPILE_START))
          
          # è½¬æ¢ä¸ºæ—¶åˆ†ç§’æ ¼å¼
          HOURS=$((DURATION_SEC / 3600))
          MINUTES=$(((DURATION_SEC % 3600) / 60))
          SECONDS=$((DURATION_SEC % 60))
          COMPILE_DURATION=$(printf "%02d:%02d:%02d" "$HOURS" "$MINUTES" "$SECONDS")
          
          echo "COMPILE_DURATION=$COMPILE_DURATION" >> "$GITHUB_ENV"
          echo "âœ… ç¼–è¯‘æ€»è€—æ—¶ï¼š$COMPILE_DURATIONï¼ˆH:M:Sï¼‰"

      - name: 13. æ£€æŸ¥ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ (Check Disk Usage)
        run: |
          echo "ğŸ’¾ ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ"
          df -hT

      - name: 14. ä¸Šä¼ Binç›®å½• (Upload Bin Directory)
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
        with:
          name: fanchmwrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: fanchmwrt/bin

      - name: 15. æ•´ç†å›ºä»¶æ–‡ä»¶ (Organize Firmware Files)
        id: organize
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          echo "ğŸ“ æ•´ç†å›ºä»¶æ–‡ä»¶"
          FIRMWARE_DIR=$(find fanchmwrt/bin/targets/*/* -type d | head -1)
          cd "$FIRMWARE_DIR"
          rm -rf packages
          
          echo "FIRMWARE=$PWD" >> "$GITHUB_ENV"
          echo "status=success" >> "$GITHUB_OUTPUT"
          echo "âœ… å›ºä»¶æ–‡ä»¶æ•´ç†å®Œæˆï¼Œç›®å½•ï¼š$PWD"

      - name: 16. ä¸Šä¼ å›ºä»¶ç›®å½• (Upload Firmware Directory)
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.status == 'success' && steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: FanchmWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      - name: 17. é‡å‘½åå›ºä»¶æ–‡ä»¶ (Rename Firmware Files)
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          echo "ğŸ”¤ é‡å‘½åå›ºä»¶æ–‡ä»¶ï¼ˆopenwrt->FanchmWrtï¼‰"
          find "${{ env.FIRMWARE }}" -name "openwrt-*.img.gz" -print0 | while IFS= read -r -d '' file; do
            if [ -f "$file" ]; then
              new_file="${file/openwrt-/FanchmWrt-}"
              mv "$file" "$new_file"
              echo "âœ… é‡å‘½åæˆåŠŸï¼š$(basename "$new_file")"
            else
              echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡ï¼š$file"
            fi
          done

      - name: 18. æå–é›†æˆæ’ä»¶åˆ—è¡¨ (Extract Plugins List)
        id: plugins
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          cd fanchmwrt
          
          # 1. å®šä¹‰é»˜è®¤ç³»ç»Ÿæ’ä»¶å’Œæ’ä»¶ä¸­æ–‡æ˜ å°„
          echo "ğŸ”§ åˆå§‹åŒ–é»˜è®¤ç³»ç»Ÿæ’ä»¶åˆ—è¡¨"
          DEFAULT_SYSTEM_PLUGINS=(
            "base-files" "busybox" "dnsmasq" "dropbear" "firewall" "fstools"
            "ip6tables" "iptables" "kmod-*" "libc" "libgcc" "logd" "mtd" "netifd"
            "opkg" "procd" "rpcd" "uci" "udevd" "wpad" "luci-base" "luci-lib-*"
            "luci-mod-*" "luci-proto-*" "luci-theme-*" "ppp" "pppoe" "pppox" "odhcp6c"
            "odhcpd-ipv6only" "ca-certificates" "openssl-util"
            "fwx-*" "luci-app-fwx-*"
          )
          
          declare -A DEFAULT_PLUGIN_CN_MAP=(
            ["luci-app-passwall"]="PassWall - ç§‘å­¦ä¸Šç½‘å·¥å…·ï¼ˆæ”¯æŒå¤šç§åè®®ï¼‰"
            ["luci-app-openclash"]="OpenClash - ç§‘å­¦ä¸Šç½‘å·¥å…·ï¼ˆClashæ ¸å¿ƒï¼‰"
            ["luci-app-ssr-plus"]="SSR-Plus - ç§‘å­¦ä¸Šç½‘å·¥å…·ï¼ˆSSR/SS/V2Rayç­‰ï¼‰"
            ["bandix"]="Bandixæµé‡ç›‘æ§ - è½»é‡çº§å®æ—¶ç½‘ç»œæµé‡å¯è§†åŒ–å·¥å…·"
            ["luci-app-bandix"]="Bandixæµé‡ç›‘æ§(Webç•Œé¢) - å›¾å½¢åŒ–ç®¡ç†æµé‡æ•°æ®"
            ["luci-app-watchdog"]="çœ‹é—¨ç‹—ç®¡ç† - ç›‘æµ‹è·¯ç”±å™¨çŠ¶æ€å¹¶è‡ªåŠ¨é‡å¯"
          )

          # 2. è¯»å–plugins.txté…ç½®
          SYSTEM_PLUGINS=()
          declare -A PLUGIN_CN_MAP=()
          
          if [ -f "${{ env.PLUGINS_FILE }}" ]; then
            echo "ğŸ“„ è§£æplugins.txté…ç½®æ–‡ä»¶"
            while IFS= read -r line; do
              # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
              [[ $line =~ ^# || -z $line ]] && continue
              
              # è§£æç³»ç»Ÿæ’é™¤æ’ä»¶
              if [[ $line =~ ^SYSTEM_PLUGIN:[[:space:]]*(.*) ]]; then
                sys_plugin=${BASH_REMATCH[1]}
                [ -n "$sys_plugin" ] && SYSTEM_PLUGINS+=("$sys_plugin")
              fi
              
              # è§£ææ’ä»¶ä¸­æ–‡è¯´æ˜
              if [[ $line =~ ^PLUGIN_CN:[[:space:]]*(.*)=(.*) ]]; then
                plugin=${BASH_REMATCH[1]}
                desc=${BASH_REMATCH[2]}
                [ -n "$plugin" ] && PLUGIN_CN_MAP["$plugin"]="$desc"
              fi
            done < "${{ env.PLUGINS_FILE }}"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°plugins.txtï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
            SYSTEM_PLUGINS=("${DEFAULT_SYSTEM_PLUGINS[@]}")
            PLUGIN_CN_MAP=("${DEFAULT_PLUGIN_CN_MAP[@]}")
          fi

          # 3. æå–å¹¶è¿‡æ»¤æ’ä»¶åˆ—è¡¨
          echo "ğŸ” æå–å·²ç¼–è¯‘æ’ä»¶åˆ—è¡¨"
          ALL_PLUGINS=$(grep -E '^CONFIG_PACKAGE_.+=y' .config | sed -r 's/CONFIG_PACKAGE_(.+)=y/\1/' | grep -v '^[0-9]*$' | sort)
          
          CUSTOM_PLUGINS=""
          for plugin in $ALL_PLUGINS; do
            # è·³è¿‡çŸ­åç§°ç³»ç»Ÿç»„ä»¶
            [ ${#plugin} -lt 3 ] && continue
            
            # åˆ¤æ–­æ˜¯å¦ä¸ºç³»ç»Ÿæ’ä»¶
            is_system=0
            for sys_plugin in "${SYSTEM_PLUGINS[@]}"; do
              if [[ $sys_plugin == *"*"* ]]; then
                pattern=${sys_plugin//\*/.*}
                [[ $plugin =~ ^$pattern$ ]] && is_system=1 && break
              else
                [[ $plugin == "$sys_plugin" || $plugin == "$sys_plugin"-* ]] && is_system=1 && break
              fi
            done
            
            # å¤„ç†è‡ªå®šä¹‰æ’ä»¶
            if [ $is_system -eq 0 ]; then
              cn_desc=${PLUGIN_CN_MAP[$plugin]}
              
              # æ¨¡ç³ŠåŒ¹é…å¸¦INCLUDEçš„æ’ä»¶
              if [ -z "$cn_desc" ]; then
                for key in "${!PLUGIN_CN_MAP[@]}"; do
                  [[ $plugin == "$key"* ]] && cn_desc=${PLUGIN_CN_MAP[$key]} && break
                done
              fi
              
              # å…œåº•æè¿°
              cn_desc=${cn_desc:-"${plugin}ï¼ˆè‡ªå®šä¹‰æ’ä»¶ï¼‰"}
              CUSTOM_PLUGINS="$CUSTOM_PLUGINS\n- $plugin - $cn_desc"
            fi
          done

          # 4. å¤„ç†ç©ºæ’ä»¶åˆ—è¡¨
          if [ -z "$CUSTOM_PLUGINS" ]; then
            CUSTOM_PLUGINS="\n- æœªæ£€æµ‹åˆ°è‡ªå®šä¹‰é›†æˆæ’ä»¶ï¼ˆä»…åŒ…å«ç³»ç»Ÿæ ¸å¿ƒç»„ä»¶ï¼‰"
          fi

          # 5. ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "PLUGINS_CONTENT=${CUSTOM_PLUGINS}" >> "$GITHUB_ENV"
          echo "âœ… ç³»ç»Ÿæ’é™¤æ’ä»¶æ•°é‡ï¼š${#SYSTEM_PLUGINS[@]}"
          echo "âœ… æ’ä»¶ä¸­æ–‡è¯´æ˜æ•°é‡ï¼š${#PLUGIN_CN_MAP[@]}"
          echo "âœ… è‡ªå®šä¹‰æ’ä»¶åˆ—è¡¨ï¼š$CUSTOM_PLUGINS"

      - name: 19. è·å–å›ºä»¶åˆ—è¡¨ (Get Firmware List)
        id: get_fw_list
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          echo "ğŸ“‹ ç”Ÿæˆå›ºä»¶æ–‡ä»¶åˆ—è¡¨"
          FW_LIST=""
          
          if [ -d "${{ env.FIRMWARE }}" ]; then
            FW_FILES=$(ls "${{ env.FIRMWARE }}"/FanchmWrt-*.img.gz 2>/dev/null)
            if [ -n "$FW_FILES" ]; then
              for fw in $FW_FILES; do
                FW_LIST="$FW_LIST\n- $(basename "$fw")"
              done
            else
              FW_LIST="\n- å·²ç¼–è¯‘å›ºä»¶ï¼š\n"
              ls "${{ env.FIRMWARE }}"/FanchmWrt-* 2>/dev/null | while read line; do
                FW_LIST="$FW_LIST  - $(basename "$line")"
              done
            fi
          else
            FW_LIST="\n- æœªè·å–åˆ°å›ºä»¶ç›®å½•"
          fi
          
          echo "FIRMWARE_LIST=${FW_LIST}" >> "$GITHUB_ENV"
          echo "âœ… å›ºä»¶åˆ—è¡¨ï¼š$FW_LIST"

      - name: 20. ç”ŸæˆReleaseè¯´æ˜ (Generate Release Notes)
        id: tag
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          echo "release_tag=${{ env.RELEASE_TAG }}" >> "$GITHUB_OUTPUT"
          
          # ç”ŸæˆReleaseè¯´æ˜æ–‡ä»¶
          echo "ğŸ“ ç”ŸæˆReleaseè¯´æ˜æ–‡ä»¶"
          cat > release.txt << EOF
## FanchmWrt å›ºä»¶ç¼–è¯‘è‡ªåŠ¨å‘å¸ƒ
- ç¼–è¯‘æ—¶é—´ï¼š${{ env.COMPILE_TIME }}
- ç¼–è¯‘æ—¶é•¿ï¼š${{ env.COMPILE_DURATION }}ï¼ˆå°æ—¶:åˆ†é’Ÿ:ç§’ï¼‰
- è®¾å¤‡å‹å·ï¼š${{ env.FULL_DEVICE_NAME }}

### ğŸ” é»˜è®¤ç™»å½•ä¿¡æ¯
- ç®¡ç†IPï¼š${{ env.MANAGE_IP }}ï¼ˆæ¥è‡ªconfig_generateä¿®æ”¹ï¼‰
- ç™»å½•è´¦å·ï¼šroot
- ç™»å½•å¯†ç ï¼špassword

### ğŸ“ å›ºä»¶æ–‡ä»¶åˆ—è¡¨
EOF
          
          # æ·»åŠ å›ºä»¶åˆ—è¡¨
          if [ -d "${{ env.FIRMWARE }}" ]; then
            FW_FILES=$(ls "${{ env.FIRMWARE }}"/FanchmWrt-*.img.gz 2>/dev/null)
            if [ -n "$FW_FILES" ]; then
              for fw in $FW_FILES; do
                echo "- $(basename "$fw")" >> release.txt
              done
            else
              echo "- å·²ç¼–è¯‘å›ºä»¶ï¼š" >> release.txt
              ls "${{ env.FIRMWARE }}"/FanchmWrt-* 2>/dev/null | xargs -I {} echo "  - $(basename {})" >> release.txt
            fi
          fi
          
          # æ·»åŠ æ’ä»¶åˆ—è¡¨
          echo -e "\n### ğŸ“¦ è‡ªå®šä¹‰é›†æˆæ’ä»¶åˆ—è¡¨ï¼ˆæ’é™¤ç³»ç»Ÿæ ¸å¿ƒç»„ä»¶ï¼‰" >> release.txt
          echo -e "${{ env.PLUGINS_CONTENT }}" | sed 's/\\n/\n/g' >> release.txt
          
          echo "status=success" >> "$GITHUB_OUTPUT"
          echo "âœ… Releaseè¯´æ˜æ–‡ä»¶ç”Ÿæˆå®Œæˆ"

      - name: 21. ç¼–è¯‘æˆåŠŸé‚®ä»¶é€šçŸ¥ (Send Success Email)
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: FanchmWrtå›ºä»¶ç¼–è¯‘æˆåŠŸé€šçŸ¥
          body: |
            æ‚¨å¥½ï¼ŒFanchmWrtå›ºä»¶ç¼–è¯‘å·²æˆåŠŸå®Œæˆï¼
            å…³é”®ä¿¡æ¯å¦‚ä¸‹ï¼š
            1. ç¼–è¯‘æ—¶é—´ï¼š${{ env.COMPILE_TIME }}
            2. ç¼–è¯‘æ—¶é•¿ï¼š${{ env.COMPILE_DURATION }}ï¼ˆå°æ—¶:åˆ†é’Ÿ:ç§’ï¼‰
            3. è®¾å¤‡å‹å·ï¼š${{ env.FULL_DEVICE_NAME }}
            4. å›ºä»¶ç®¡ç†IPï¼š${{ env.MANAGE_IP }}
            5. å·¥ä½œæµIDï¼š${{ github.run_id }}
            6. å›ºä»¶æ–‡ä»¶åˆ—è¡¨ï¼š${{ env.FIRMWARE_LIST }}
            7. è‡ªå®šä¹‰é›†æˆæ’ä»¶åˆ—è¡¨ï¼ˆæ’é™¤ç³»ç»Ÿç»„ä»¶ï¼‰ï¼š${{ env.PLUGINS_CONTENT }}
            8. Releaseé“¾æ¥ï¼šhttps://github.com/${{ github.repository }}/releases/tag/${{ env.RELEASE_TAG }}
            9. æ—¥å¿—é“¾æ¥ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.RECEIVE_EMAIL }}
          from: GitHub Actions
          secure: true

      - name: 22. ç¼–è¯‘å¤±è´¥é‚®ä»¶é€šçŸ¥ (Send Failure Email)
        if: failure() && steps.compile.conclusion == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: FanchmWrtå›ºä»¶ç¼–è¯‘å¤±è´¥é€šçŸ¥
          body: |
            æ‚¨å¥½ï¼ŒFanchmWrtå›ºä»¶ç¼–è¯‘å·¥ä½œæµè¿è¡Œå¤±è´¥ï¼
            ä»“åº“åœ°å€ï¼š${{ github.repository }}
            å·¥ä½œæµè¿è¡ŒIDï¼š${{ github.run_id }}
            æ—¥å¿—é“¾æ¥ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.RECEIVE_EMAIL }}
          from: GitHub Actions
          secure: true

      - name: 23. ä¸Šä¼ å›ºä»¶åˆ°Release (Upload to GitHub Release)
        uses: softprops/action-gh-release@v1
        if: steps.compile.outputs.status == 'success' && steps.tag.outputs.status == 'success' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: |
            ${{ env.FIRMWARE }}/FanchmWrt-*.img.gz
            ${{ env.FIRMWARE }}/sha256sums
          overwrite: true

      - name: 24. åˆ é™¤æ—§å·¥ä½œæµè®°å½• (Delete Old Workflow Runs)
        uses: Mattraks/delete-workflow-runs@v2
        if: steps.compile.outputs.status == 'success' && !cancelled()
        with:
          retain_days: 0
          keep_minimum_runs: 2

      - name: 25. åˆ é™¤æ—§Releaseç‰ˆæœ¬ (Delete Old Releases)
        uses: dev-drprasad/delete-older-releases@v0.3.0
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
