name: ç¼–è¯‘ OpenWrt/FanchmWrt å›ºä»¶

on:
  push:
    branches: [ main ]
    paths:
      - 'diy-part1.sh'
      - 'diy-part2.sh'
      - 'plugins.txt'
      - '.github/workflows/build-openwrt.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ç¼–è¯‘

env:
  # è‡ªå®šä¹‰é…ç½®ï¼ˆæ ¹æ®ä½ çš„é¡¹ç›®è°ƒæ•´ï¼‰
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-21.02
  FEEDS_CONF: feeds.conf.default
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  PLUGINS_FILE: plugins.txt  # æ’ä»¶é…ç½®æ–‡ä»¶è·¯å¾„
  UPLOAD_RELEASE: true       # æ˜¯å¦ä¸Šä¼ åˆ°Release
  TZ: Asia/Shanghai          # æ—¶åŒº

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write  # å…è®¸ä¸Šä¼ Release

    steps:
    - name: æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt update -y
        sudo apt full-upgrade -y
        sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
          git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
          libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
          mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pip qemu-utils \
          rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev

    - name: å…‹éš†æºç ä»“åº“
      run: |
        git clone --depth 1 ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} openwrt
        ln -sf ../${{ env.PLUGINS_FILE }} openwrt/${{ env.PLUGINS_FILE }}  # é“¾æ¥æ’ä»¶é…ç½®æ–‡ä»¶åˆ°æºç ç›®å½•
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      run: |
        [ -f ${{ env.FEEDS_CONF }} ] && cp ${{ env.FEEDS_CONF }} openwrt/feeds.conf.default
        [ -f ${{ env.DIY_P1_SH }} ] && chmod +x ${{ env.DIY_P1_SH }} && cd openwrt && ../${{ env.DIY_P1_SH }}
        [ -f ${{ env.DIY_P2_SH }} ] && chmod +x ${{ env.DIY_P2_SH }} && cd openwrt && ../${{ env.DIY_P2_SH }}

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd openwrt
        make defconfig
        make download -j8
        make -j$(nproc) || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        # æ”¶é›†å›ºä»¶ä¿¡æ¯
        echo "FIRMWARE_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
        echo "FIRMWARE_BRANCH=${{ env.REPO_BRANCH }}" >> $GITHUB_ENV

    - name: æå–å›ºä»¶é›†æˆæ’ä»¶åˆ—è¡¨ï¼ˆç²¾å‡†è¿‡æ»¤+å…¨åŒ¹é…ï¼‰
      id: plugins
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        cd openwrt  # æ³¨æ„è·¯å¾„ï¼šæºç å…‹éš†åœ¨openwrtç›®å½•ï¼Œéfanchmwrt
        # 1. è¯»å–plugins.txté…ç½®
        SYSTEM_PLUGINS=()
        declare -A PLUGIN_CN_MAP=()
        if [ -f "${{ env.PLUGINS_FILE }}" ]; then
          while IFS= read -r line; do
            [[ $line =~ ^# || -z $line ]] && continue
            # è§£æç³»ç»Ÿæ’é™¤æ’ä»¶ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
            if [[ $line =~ ^SYSTEM_PLUGIN:[[:space:]]*(.*) ]]; then
              sys_plugin=${BASH_REMATCH[1]}
              [ -n "$sys_plugin" ] && SYSTEM_PLUGINS+=("$sys_plugin")
            fi
            # è§£ææ’ä»¶ä¸­æ–‡ä»‹ç»ï¼ˆæ”¯æŒå¸¦INCLUDEçš„é•¿åç§°ï¼‰
            if [[ $line =~ ^PLUGIN_CN:[[:space:]]*(.*)=(.*) ]]; then
              plugin=${BASH_REMATCH[1]}
              desc=${BASH_REMATCH[2]}
              [ -n "$plugin" ] && PLUGIN_CN_MAP["$plugin"]="$desc"
            fi
          done < "${{ env.PLUGINS_FILE }}"
        else
          # å…œåº•é»˜è®¤å€¼
          SYSTEM_PLUGINS=("base-files" "busybox" "luci-base" "lib*" "lua*")
          PLUGIN_CN_MAP=()
        fi

        # 2. æå–æ‰€æœ‰å·²é€‰ä¸­çš„æ’ä»¶ï¼ˆè¿‡æ»¤æ‰çº¯æ•°å­—å’Œç©ºåç§°ï¼‰
        ALL_PLUGINS=$(grep -E '^CONFIG_PACKAGE_.+=y' .config | sed -r 's/CONFIG_PACKAGE_(.+)=y/\1/' | grep -v '^[0-9]*$' | sort)
        
        # 3. ç²¾å‡†è¿‡æ»¤ç³»ç»Ÿæ’ä»¶ï¼ˆæ”¯æŒé€šé…ç¬¦åŒ¹é…ï¼‰
        CUSTOM_PLUGINS=""
        for plugin in $ALL_PLUGINS; do
          is_system=0
          # è·³è¿‡å¤ªçŸ­çš„ç³»ç»Ÿç»„ä»¶ï¼ˆé•¿åº¦<3ï¼‰
          [ ${#plugin} -lt 3 ] && continue
          # åŒ¹é…ç³»ç»Ÿæ’é™¤æ¸…å•ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
          for sys_plugin in "${SYSTEM_PLUGINS[@]}"; do
            if [[ $sys_plugin == *"*"* ]]; then
              pattern=${sys_plugin//\*/.*}
              [[ $plugin =~ ^$pattern$ ]] && is_system=1 && break
            else
              [[ $plugin == "$sys_plugin" || $plugin == "$sys_plugin"-* ]] && is_system=1 && break
            fi
          done
          # éç³»ç»Ÿæ’ä»¶ï¼ŒåŒ¹é…ä¸­æ–‡ä»‹ç»ï¼ˆä¼˜å…ˆå®Œå…¨åŒ¹é…ï¼Œå†æ¨¡ç³ŠåŒ¹é…ï¼‰
          if [ $is_system -eq 0 ]; then
            cn_desc=${PLUGIN_CN_MAP[$plugin]}
            # æ¨¡ç³ŠåŒ¹é…å¸¦INCLUDEçš„æ’ä»¶ï¼ˆå¦‚luci-app-bypass_INCLUDE_XXXï¼‰
            if [ -z "$cn_desc" ]; then
              for key in "${!PLUGIN_CN_MAP[@]}"; do
                [[ $plugin == "$key"* ]] && cn_desc=${PLUGIN_CN_MAP[$key]} && break
              done
            fi
            # æ— åŒ¹é…æ—¶æ˜¾ç¤ºæ’ä»¶åï¼ˆé¿å…ç©ºæè¿°ï¼‰
            cn_desc=${cn_desc:-"${plugin}ï¼ˆè‡ªå®šä¹‰æ’ä»¶ï¼‰"}
            CUSTOM_PLUGINS="$CUSTOM_PLUGINS\n- $plugin - $cn_desc"
          fi
        done

        # 4. å¤„ç†ç©ºåˆ—è¡¨
        if [ -z "$CUSTOM_PLUGINS" ]; then
          CUSTOM_PLUGINS="\n- æœªæ£€æµ‹åˆ°è‡ªå®šä¹‰é›†æˆæ’ä»¶ï¼ˆä»…åŒ…å«ç³»ç»Ÿæ ¸å¿ƒç»„ä»¶ï¼‰"
        fi

        # 5. å†™å…¥ç¯å¢ƒå˜é‡
        echo "PLUGINS_CONTENT=${CUSTOM_PLUGINS}" >> $GITHUB_ENV
        echo "âœ… è¿‡æ»¤åè‡ªå®šä¹‰æ’ä»¶æ•°é‡ï¼š$(echo -e "$CUSTOM_PLUGINS" | grep -c '^- ')"

    - name: æ‰“åŒ…å›ºä»¶æ–‡ä»¶
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        mkdir -p firmware
        mv *.bin *.img *.tar.gz *.zip firmware/
        tar -zcvf openwrt-firmware-${{ env.FIRMWARE_DATE }}.tar.gz firmware/

    - name: ä¸Šä¼ å›ºä»¶åˆ°Release
      uses: softprops/action-gh-release@v1
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        tag_name: ${{ env.FIRMWARE_DATE }}
        name: OpenWrt å›ºä»¶ç¼–è¯‘ ${{ env.FIRMWARE_DATE }}
        body: |
          ### ğŸ“… ç¼–è¯‘ä¿¡æ¯
          - æºç åˆ†æ”¯ï¼š${{ env.REPO_BRANCH }}
          - ç¼–è¯‘æ—¶é—´ï¼š${{ env.FIRMWARE_DATE }}
          - ç³»ç»Ÿæ—¶åŒºï¼š${{ env.TZ }}

          ### ğŸ“¦ è‡ªå®šä¹‰é›†æˆæ’ä»¶åˆ—è¡¨ï¼ˆæ’é™¤ç³»ç»Ÿæ ¸å¿ƒç»„ä»¶ï¼‰
          ${{ env.PLUGINS_CONTENT }}

          ### âš ï¸ æ³¨æ„äº‹é¡¹
          1. å›ºä»¶ä»…é€‚é…å¯¹åº”ç¡¬ä»¶æ¶æ„ï¼Œè¯·ç¡®è®¤è®¾å¤‡å‹å·ååˆ·å†™ï¼›
          2. é¦–æ¬¡åˆ·å†™å»ºè®®æ¢å¤å‡ºå‚è®¾ç½®ï¼Œé¿å…é…ç½®å†²çªï¼›
          3. æ’ä»¶åŠŸèƒ½è¯·å‚è€ƒä¸­æ–‡ä»‹ç»ï¼Œéƒ¨åˆ†æ’ä»¶éœ€æ‰‹åŠ¨é…ç½®åç”Ÿæ•ˆã€‚
        files: openwrt/bin/targets/*/*/openwrt-firmware-${{ env.FIRMWARE_DATE }}.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
